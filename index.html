<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>[under construction] Frame3S - Regionalization</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    .map-header {
      position: absolute; z-index: 1000; left: 10px; top: 10px;
      background: white; padding: 8px 10px; border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,.15); font-family: system-ui, sans-serif;
    }
    .leaflet-control-layers { font-family: system-ui, sans-serif; }
    .footer {
      position: absolute; z-index: 1000; right: 10px; bottom: 35px;
      background: rgba(255,255,255,.95); padding: 6px 10px; border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,.15); font-family: system-ui, sans-serif;
      font-size: 12px;
    }
    .legend {
      position: absolute; left: 10px; bottom: 10px; z-index: 1000;
      background: rgba(255,255,255,.95); padding: 8px 10px; border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,.15); font-family: system-ui, sans-serif;
      font-size: 12px; line-height: 1.2;
    }
    .legend-row {
      display: flex; align-items: center; margin: 4px 0;
    }
    .legend-swatch {
      width: 36px; height: 10px; margin-right: 8px;
      display: inline-block;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="map-header">
    <strong>[under construction] Frame3S - Regionalization</strong><br>
    <small>Toggle layers via the control (top-right)</small>
  </div>
  <div class="legend">
    <div style="font-weight:600; margin-bottom:4px;">Legend</div>
    <div class="legend-row">
      <svg class="legend-swatch" viewBox="0 0 36 10" xmlns="http://www.w3.org/2000/svg">
        <line x1="0" y1="5" x2="36" y2="5" stroke="#8B0000" stroke-width="4" />
      </svg>
      <span>Euregio Boundary</span>
    </div>
    <div class="legend-row">
      <svg class="legend-swatch" viewBox="0 0 36 10" xmlns="http://www.w3.org/2000/svg">
        <line x1="0" y1="5" x2="36" y2="5" stroke="#1f78b4" stroke-width="2" />
      </svg>
      <span>LWD Subregions Euregio</span>
    </div>
    <div class="legend-row">
      <svg class="legend-swatch" viewBox="0 0 36 10" xmlns="http://www.w3.org/2000/svg">
        <line x1="0" y1="5" x2="36" y2="5" stroke="#000000" stroke-width="2" />
      </svg>
      <span>GMBA Inventory L8</span>
    </div>
  </div>
  <div class="footer">
    © 2025 Franz Wagner – University of Innsbruck – <a href="mailto:franz.wagner@uibk.ac.at">franz.wagner@uibk.ac.at</a>
  </div>

<script>
  // === Map init (fixed center/zoom) ===
  const INITIAL_CENTER = [46.7842128, 11.6037210];
  const INITIAL_ZOOM   = 8; // ≈ 1:2,000,000 depending on display DPI

  const map = L.map('map', { zoomControl: true }).setView(INITIAL_CENTER, INITIAL_ZOOM);
  L.control.scale({ metric: true, imperial: false }).addTo(map);

  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution:
      '&copy; OpenStreetMap contributors | ' +
      'LWD Euregio regions (CC0 1.0) | ' +
      'GMBA Mountain Inventory v2 (© 2022 GMBA-EarthEnv, ' +
      '<a href="https://doi.org/10.48601/EARTHENV-T9K2-1407" target="_blank">CC BY 4.0</a>)'
  }).addTo(map);



  const esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Tiles © Esri'
  });

  const baseMaps = { "OpenStreetMap": osm, "Esri World Imagery": esriSat };

  // Styles
  const layerStyles = {
    lwd_subregions_euregio: { color: '#1f78b4', weight: 2, fillOpacity: 0.15 },
    GMBA_Inventory_L8:      { color: '#000000', weight: 2, fillOpacity: 0.15 },
    euregio:                { color: '#8B0000', weight: 4, fillOpacity: 0 }
  };

  const overlays = {};
  const overlayMaps = {};
  let loadedBounds = [];   // store valid bounds from non-empty layers
  let layersLoaded = 0;    // diagnostic

  // Helper: basic bounds sanity (coordinates within longitude/latitude ranges)
  function boundsLooksValid(b) {
    try {
      const sw = b.getSouthWest(), ne = b.getNorthEast();
      const ok =
        sw.lng >= -180 && sw.lng <= 180 &&
        ne.lng >= -180 && ne.lng <= 180 &&
        sw.lat >= -90  && sw.lat <= 90  &&
        ne.lat >= -90  && ne.lat <= 90  &&
        (ne.lng - sw.lng) > 0 && (ne.lat - sw.lat) > 0;
      return ok;
    } catch { return false; }
  }

  // Safer loader with diagnostics and cache-busting
  function addGeoJSON(url, key, displayName) {
    const busted = url + (url.includes('?') ? '&' : '?') + 'v=' + Date.now();

    fetch(busted)
      .then(r => {
        if (!r.ok) throw new Error(`HTTP ${r.status} for ${url}`);
        return r.json();
      })
      .then(geo => {
        const features = Array.isArray(geo.features) ? geo.features.length : 0;
        console.log(`[${displayName}] Loaded ${features} features from ${url}`);

        const gj = L.geoJSON(geo, {
          style: () => layerStyles[key] || {},
          pointToLayer: (feature, latlng) =>
            L.circleMarker(latlng, {
              radius: 5,
              weight: 2,
              color: (layerStyles[key] && layerStyles[key].color) || '#333',
              fillOpacity: (layerStyles[key] && layerStyles[key].fillOpacity) || 0.5
            }),
          onEachFeature: (feature, layer) => {
            const props = feature?.properties || {};
            const rows = Object.entries(props)
              .map(([k, v]) => `<tr><th style="text-align:left;padding-right:8px;white-space:nowrap">${k}</th><td>${v}</td></tr>`)
              .join("");
            if (rows) layer.bindPopup(`<table>${rows}</table>`);
          }
        }).addTo(map);

        overlays[key] = gj;
        overlayMaps[displayName] = gj;

        // Refresh layer control
        if (window._layersControl) window._layersControl.remove();
        window._layersControl = L.control.layers(baseMaps, overlayMaps, { collapsed: false }).addTo(map);

        // Only collect bounds if there are features and the bounds look sane
        const hasBounds = typeof gj.getBounds === 'function' ? gj.getBounds() : null;
        if (features > 0 && hasBounds && hasBounds.isValid() && boundsLooksValid(hasBounds)) {
          loadedBounds.push(hasBounds);
          console.log(`[${displayName}] Bounds:`, hasBounds.toBBoxString());
        } else {
          console.warn(`[${displayName}] No valid bounds (empty layer, invalid CRS, or bad coords).`);
        }

        layersLoaded += 1;

        // Optional: if BOTH layers load with valid bounds, you could auto-fit once.
        // If you prefer to ALWAYS keep the initial center/zoom, comment this block out.
        if (loadedBounds.length > 0 && layersLoaded >= 2) {
          const merged = loadedBounds.reduce((acc, b) => acc ? acc.extend(b) : b, null);
          if (merged && merged.isValid() && boundsLooksValid(merged)) {
            // map.fitBounds(merged, { padding: [20, 20] }); // <- enable only if you want auto-fit
          }
        }
      })
      .catch(err => {
        console.error(`Failed to load ${url}`, err);
        alert(`Failed to load: ${url}\n${err.message}`);
      });
  }

  // Load your layers (paths are case-sensitive!)
  addGeoJSON('data/lwd_subregions_euregio.geojson', 'lwd_subregions_euregio', 'LWD Subregions Euregio');
  addGeoJSON('data/GMBA_Inventory_L8.geojson',      'GMBA_Inventory_L8',      'GMBA Inventory L8');
  addGeoJSON('data/euregio.geojson', 'euregio', 'Euregio Boundary');

</script>

</body>
</html>
